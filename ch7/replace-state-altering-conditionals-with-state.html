<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Replace State-Altering Conditionals with State | Refactoring to Patterns Notes</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="重構－向範式前進 (Refactoring to Patterns) 的學習筆記">
    
    <link rel="preload" href="/refactoring-to-patterns-notes/assets/css/0.styles.6e150cc6.css" as="style"><link rel="preload" href="/refactoring-to-patterns-notes/assets/js/app.a208a22b.js" as="script"><link rel="preload" href="/refactoring-to-patterns-notes/assets/js/2.51c787ed.js" as="script"><link rel="preload" href="/refactoring-to-patterns-notes/assets/js/7.3b43ce78.js" as="script"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/10.a8b6feca.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/11.e8707b0f.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/12.6161216a.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/13.bddbc3f1.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/14.8e69fa8c.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/15.6b065f0b.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/16.efc1e594.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/17.858a17be.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/18.d06cb0cf.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/19.418313d9.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/20.f79cdba6.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/21.23785dd1.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/22.bacf66aa.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/23.aa50f31c.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/24.6ec48ef6.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/25.1539a044.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/26.42683f05.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/27.bbda665d.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/28.7e2dd886.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/29.257869e9.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/3.9b1b1d10.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/30.a5c44f3e.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/31.1eaf762c.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/32.263ca8d0.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/33.1063a403.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/34.66e360ee.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/35.507f8533.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/36.e65193aa.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/37.381e0f42.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/38.8cfddfb6.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/39.bf3340ba.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/4.07606512.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/40.041494b6.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/5.54b92973.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/6.a3474fa1.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/8.69effecb.js"><link rel="prefetch" href="/refactoring-to-patterns-notes/assets/js/9.b6ca2281.js">
    <link rel="stylesheet" href="/refactoring-to-patterns-notes/assets/css/0.styles.6e150cc6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/refactoring-to-patterns-notes/" class="home-link router-link-active"><!----> <span class="site-name">Refactoring to Patterns Notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/refactoring-to-patterns-notes/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/aquastripe/refactoring-to-patterns-notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/refactoring-to-patterns-notes/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/aquastripe/refactoring-to-patterns-notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/refactoring-to-patterns-notes/" aria-current="page" class="sidebar-link">Preface</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Ch 1: Why I wrote this book</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/refactoring-to-patterns-notes/ch1/" class="sidebar-link">為什麼寫這本書</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Ch 2: Refactoring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/refactoring-to-patterns-notes/ch2/" class="sidebar-link">重構</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Ch 3: Patterns</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/refactoring-to-patterns-notes/ch3/" class="sidebar-link">設計模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Ch 4: Code Smells</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/refactoring-to-patterns-notes/ch4/" class="sidebar-link">程式碼壞味道</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Ch 5: A Catalog of Refactorings to Patterns</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/refactoring-to-patterns-notes/ch5/" class="sidebar-link">Refactorings to Patterns 名錄</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Ch 6: Creation</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/refactoring-to-patterns-notes/ch6/" class="sidebar-link">創建</a></li><li><a href="/refactoring-to-patterns-notes/ch6/replace-constructors-with-creation-methods.html" class="sidebar-link">Replace Constructors with Creation Methods</a></li><li><a href="/refactoring-to-patterns-notes/ch6/move-creation-knowledge-to-factory.html" class="sidebar-link">Move Creation Knowledge to Factory</a></li><li><a href="/refactoring-to-patterns-notes/ch6/encapsulate-classes-with-factory.html" class="sidebar-link">Encapsulate Classes with Factory</a></li><li><a href="/refactoring-to-patterns-notes/ch6/introduce-polymorphic-creation-with-factory-method.html" class="sidebar-link">Introduce Polymorphic Creation with Factory Method</a></li><li><a href="/refactoring-to-patterns-notes/ch6/inline-singleton.html" class="sidebar-link">Inline Singleton</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Ch 7: Simplification</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/refactoring-to-patterns-notes/ch7/compose-method.html" class="sidebar-link">Compose Method</a></li><li><a href="/refactoring-to-patterns-notes/ch7/replace-conditional-logic-with-strategy.html" class="sidebar-link">Replace Conditional Logic with Strategy</a></li><li><a href="/refactoring-to-patterns-notes/ch7/replace-implicit-tree-with-composite.html" class="sidebar-link">Replace Implicit Tree with Composite</a></li><li><a href="/refactoring-to-patterns-notes/ch7/replace-conditional-dispatcher-with-command.html" class="sidebar-link">Replace Conditional Dispatcher with Command</a></li><li><a href="/refactoring-to-patterns-notes/ch7/replace-state-altering-conditionals-with-state.html" aria-current="page" class="active sidebar-link">Replace State-Altering Conditionals with State</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/refactoring-to-patterns-notes/ch7/replace-state-altering-conditionals-with-state.html#動機" class="sidebar-link">動機</a></li><li class="sidebar-sub-header"><a href="/refactoring-to-patterns-notes/ch7/replace-state-altering-conditionals-with-state.html#作法" class="sidebar-link">作法</a></li><li class="sidebar-sub-header"><a href="/refactoring-to-patterns-notes/ch7/replace-state-altering-conditionals-with-state.html#範例" class="sidebar-link">範例</a></li></ul></li><li><a href="/refactoring-to-patterns-notes/ch7/move-embellishment-to-decorator.html" class="sidebar-link">Move Embellishment to Decorator</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Ch 8: Generalization</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/refactoring-to-patterns-notes/ch8/form-template-method.html" class="sidebar-link">Form Template Method</a></li><li><a href="/refactoring-to-patterns-notes/ch8/extract-composite.html" class="sidebar-link">Extract Composite</a></li><li><a href="/refactoring-to-patterns-notes/ch8/replace-one-many-distinctions-with-composite.html" class="sidebar-link">Replace One/Many Distinctions with Composite</a></li><li><a href="/refactoring-to-patterns-notes/ch8/replace-implicit-language-with-interpreter.html" class="sidebar-link">Replace Implicit Language with Interpreter</a></li><li><a href="/refactoring-to-patterns-notes/ch8/extract-adapter.html" class="sidebar-link">Extract Adapter</a></li><li><a href="/refactoring-to-patterns-notes/ch8/unify-interfaces-with-adapter.html" class="sidebar-link">Unify Interfaces with Adapter</a></li><li><a href="/refactoring-to-patterns-notes/ch8/replace-hard-coded-notifications-with-observer.html" class="sidebar-link">Replace Hard-Coded Notifications with Observer</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Ch 9: Protection</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/refactoring-to-patterns-notes/ch9/replace-type-code-with-class.html" class="sidebar-link">Replace Type Code with Class</a></li><li><a href="/refactoring-to-patterns-notes/ch9/introduce-null-object.html" class="sidebar-link">Introduce Null Object</a></li><li><a href="/refactoring-to-patterns-notes/ch9/limit-instantiation-with-singleton.html" class="sidebar-link">Limit Instantiation with Singleton</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Ch 10: Accumulation</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/refactoring-to-patterns-notes/ch10/move-accumulation-to-collecting-parameter.html" class="sidebar-link">Move Accumulation to Collecting Parameter</a></li><li><a href="/refactoring-to-patterns-notes/ch10/move-accumulation-to-visitor.html" class="sidebar-link">Move Accumulation to Visitor</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Ch 11: Utilities</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/refactoring-to-patterns-notes/ch11/" class="sidebar-link">工具</a></li><li><a href="/refactoring-to-patterns-notes/ch11/chain-constructors.html" class="sidebar-link">Chain Constructors</a></li><li><a href="/refactoring-to-patterns-notes/ch11/unify-interfaces.html" class="sidebar-link">Unify Interfaces</a></li><li><a href="/refactoring-to-patterns-notes/ch11/extract-parameter.html" class="sidebar-link">Extract Parameter</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="replace-state-altering-conditionals-with-state"><a href="#replace-state-altering-conditionals-with-state" class="header-anchor">#</a> Replace State-Altering Conditionals with State</h1> <p>以 State 替代「狀態變換」條件句。</p> <p>控制「物件的狀態轉移」條件句很複雜。因此，拿「用來處理特定狀態和狀態轉移」的 <strong>State</strong> 類別取代條件句。</p> <p><img src="/refactoring-to-patterns-notes/assets/img/7.4.0.9cb49cc5.jpg" alt=""></p> <h2 id="動機"><a href="#動機" class="header-anchor">#</a> 動機</h2> <p>Refactor to <strong>State</strong> pattern 的主要動機是簡化過度複雜的狀態轉換邏輯。這個邏輯（其本身容易把自己擴散到整個類別）控制著物件的狀態，也控制著如何轉換到其他狀態。實作 <strong>State</strong> pattern 時你需要建立一些類別來表達物件的 特定狀態 和 狀態間的轉換。Design Patterns 把 狀態被改變的物件 稱為 context。Context 把「與狀態相依的行為」委託（delegate）給 state 物件去做。只要讓 context 在執行期指向不同的 state 物件，就可以造成狀態轉移。</p> <p>把狀態轉換邏輯從類別中移出，導入一系列可表現不同狀態的類別，就可以創造出較簡單的設計，提供對狀態轉移的全局觀點。但另一方面，如果你能輕鬆了解類別的狀態轉移邏輯，也許就不需要 refactor to <strong>State</strong> pattern，除非計劃未來要增加更多的狀態轉移。</p> <p>在進行 refactor to <strong>State</strong> 之前，先看看是否有較簡單的重構方法（e.g. <em>Extract Method</em>）能夠幫忙梳理狀態轉換條件邏輯。</p> <p><em>Replace State-Altering Conditionals with State</em> 不同於 Martin Fowler 的 <em>Replace Type Code with State/Strategy</em>，因為：</p> <ul><li><strong>State</strong> 和 <strong>Strategy</strong> 之間存在差異：<strong>State</strong> pattern 對「必須在一系列 state 類別的實體之間輕鬆轉換」的類別有益，而 <strong>Strategy</strong> pattern 則是有助於讓類別把演算法執行任務委託給「一系列 <strong>Strategy</strong> 類別的某個實體」。由於這些差異，造成兩個模式為重構目標的動機和作法有所不同（請見：<a href="/refactoring-to-patterns-notes/ch7/replace-conditional-logic-with-strategy.html">Replace Conditional Logic with Strategy</a>）。</li> <li>完整的作法：Martin 刻意不寫 refactor to <strong>State</strong> pattern 的全部作法，因為他完整實作有賴於他寫的另一項重構：<em>Replace Conditional with Polymorphism</em>。</li></ul> <p>如果你的 state 物件沒有 instance 變數（也就是它們是無狀態的，stateless），你可以讓 context 物件共享這個「stateless state 實體」，讓記憶體用量最佳化。<strong>Flyweight</strong> 和 <strong>Singleton</strong> patterns 經常用來實現共享（sharing，請見 <a href="/refactoring-to-patterns-notes/ch9/limit-instantiation-with-singleton.html">Limit Instantiation with Singleton</a>）。然而當你的用戶體驗過系統延遲，效能剖析器向你指出 state-instantiation code 是主要瓶頸時，你最好加上 state-sharing code。</p> <div class="custom-block tip"><p class="custom-block-title">優點</p> <ul><li>減少或移除 state-changing 條件邏輯。</li> <li>簡化複雜的 state-changing 邏輯。</li> <li>為 state-changing 邏輯提供良好的全局觀點。</li></ul></div> <div class="custom-block warning"><p class="custom-block-title">缺點</p> <ul><li>如果狀態轉移邏輯已經很容易被領會，這樣做會讓設計變得更複雜。</li></ul></div> <h2 id="作法"><a href="#作法" class="header-anchor">#</a> 作法</h2> <ol><li><p>所謂的 context 是指含有原始狀態欄位的那個類別，在狀態轉移中，該欄位被賦予或比對一整系列的常數。在這個欄位上實施 <a href="/refactoring-to-patterns-notes/ch9/replace-type-code-with-class.html">Replace Type Code with Class</a>，便可以使其型別成為一個類別。我們把這個新類別稱為 state superclass。</p> <p>context 類別是 Design Patterns 中的 State:Context，而 state superclass 就是 Design Patterns 中的 State:State。</p></li> <li><p>上述的 state superclass 內的每一個常數現在都指涉一個 state superclass 實體。</p> <ol><li>實施 <em>Extract Subclass</em> 針對每個常數產生一個子類別（i.e. State:ConcreteState）。</li> <li>然後，更新 state superclass 中的所有常數，使每一個常數都指涉 state superclass 的一個正確的子類別實體。</li> <li>最後，將 state superclass 宣告為 abstract。</li></ol></li> <li><p>找出一個會依據「狀態轉移邏輯」改變「原始狀態欄位值」的 context 類別函式。把這個函式複製到 state superclass，做盡可能簡單的改變，讓新函式運作起來。常見的簡單改變是把 context 類別傳給該函式以便該函式能呼叫 context 類別的各個函式。最後再以一個「對新函式的委託呼叫」取代剛才的 context 類別函式的本體。</p> <p>針對每一個依據「狀態轉移邏輯」改變「原始狀態欄位值」的 context 類別函式，重複執行此步驟。</p></li> <li><p>選擇一個 context 類別可進入的狀態，然後找出是哪個 state superclass 函式讓這個狀態轉移到其他狀態。如果有，把找到的函式複製到與上述所選狀態相關的子類別，並移除所有無關的邏輯。</p> <p>此處所謂無關邏輯往往包括「當前狀態驗證」或「轉移到無關狀態」的邏輯。</p> <p>針對 context 類別可進入的每個狀態，重複進行上述的步驟。</p></li> <li><p>刪除步驟 3. 期間複製到 state superclass 的每一個函式的原先本體，為每個函式產生一份空實作。</p></li></ol> <h2 id="範例"><a href="#範例" class="header-anchor">#</a> 範例</h2> <p>想了解 refactor to <strong>State</strong> pattern 的合理時機，先研究一個「不需要 <strong>State</strong> pattern 的複雜機制就能管理其狀態」的類別應該可以帶來幫助。<code>SystemPermission</code> 就是這樣的類別，他以簡單的條件邏輯記錄「某一個軟體系統的許可申請」狀態。在 <code>SystemPermission</code> 物件生命期間，一個名為 <code>state</code> 的 instance 變數會在 requested（用戶申請）、claimed（管理員提議）、denied（否決）和 granted（同意）等狀態之間切換。以下是狀態圖：</p> <p><img src="/refactoring-to-patterns-notes/assets/img/7.4.1.4e0cdf00.jpg" alt=""></p> <p>以下是 <code>SystemPermission</code> 的程式碼和展示這個類別用法的測試片段：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SystemPermission</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">private</span> <span class="token class-name">SystemProfile</span> profile<span class="token punctuation">;</span> 
    <span class="token keyword">private</span> <span class="token class-name">SystemUser</span> requestor<span class="token punctuation">;</span> 
    <span class="token keyword">private</span> <span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">;</span> 
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isGranted<span class="token punctuation">;</span> 
    <span class="token keyword">private</span> <span class="token class-name">String</span> state<span class="token punctuation">;</span> 
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> REQUESTED <span class="token operator">=</span> <span class="token string">&quot;REQUESTED&quot;</span><span class="token punctuation">;</span> 
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> CLAIMED <span class="token operator">=</span> <span class="token string">&quot;CLAIMED&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> GRANTED <span class="token operator">=</span> <span class="token string">&quot;GRANTED&quot;</span><span class="token punctuation">;</span> 
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> DENIED <span class="token operator">=</span> <span class="token string">&quot;DENIED&quot;</span><span class="token punctuation">;</span> 
    
    <span class="token keyword">public</span> <span class="token class-name">SystemPermission</span><span class="token punctuation">(</span><span class="token class-name">SystemUser</span> requestor<span class="token punctuation">,</span> <span class="token class-name">SystemProfile</span> profile<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>requestor <span class="token operator">=</span> requestor<span class="token punctuation">;</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>profile <span class="token operator">=</span> profile<span class="token punctuation">;</span> 
        state <span class="token operator">=</span> REQUESTED<span class="token punctuation">;</span> 
        isGranted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 
        <span class="token function">notifyAdminOfPermissionRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">claimedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>REQUESTED<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
            
        <span class="token function">willBeHandledBy</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        state <span class="token operator">=</span> CLAIMED<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deniedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>CLAIMED<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
            
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>admin<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
        
        isGranted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 
        state <span class="token operator">=</span> DENIED<span class="token punctuation">;</span> 
        <span class="token function">notifyUserOfPermissionRequestResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">grantedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>CLAIMED<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
            
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>admin<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
            
        state <span class="token operator">=</span> GRANTED<span class="token punctuation">;</span> 
        isGranted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
        <span class="token function">notifyUserOfPermissionRequestResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestStates</span> <span class="token keyword">extends</span> <span class="token class-name">TestCase</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">private</span> <span class="token class-name">SystemPermission</span> permission<span class="token punctuation">;</span> 
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        permission <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemPermission</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> profile<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGrantedBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        permission<span class="token punctuation">.</span><span class="token function">grantedBy</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;requested&quot;</span><span class="token punctuation">,</span> permission<span class="token punctuation">.</span>REQUESTED<span class="token punctuation">,</span> permission<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;not granted&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> permission<span class="token punctuation">.</span><span class="token function">isGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        permission<span class="token punctuation">.</span><span class="token function">claimedBy</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        permission<span class="token punctuation">.</span><span class="token function">grantedBy</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;granted&quot;</span><span class="token punctuation">,</span> permission<span class="token punctuation">.</span>GRANTED<span class="token punctuation">,</span> permission<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;granted&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> permission<span class="token punctuation">.</span><span class="token function">isGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><p>注意，當用戶呼叫特定的某個 <code>SystemPermission</code> 函式時，instance 變數 <code>state</code> 是如何被賦予不同的值。現在看看 <code>SystemPermission</code> 的整個條件邏輯，這個邏輯有責任狀態轉移，但不是非常複雜，因此不需要 <strong>State</strong> pattern 那麼複雜的機制。</p> <p>但是當更多行為添加到 <code>SystemPermission</code> 類別時，上面的狀態改變邏輯有可能很快就變得難以領會。例如，我之前曾經協助設計一個安全系統，用戶在獲得某個給定的軟體系統的一般性許可之前必須先獲得 UNIX 或 database 許可。「UNIX 許可必須先於一般性許可」的狀態轉移邏輯可能看起來像這樣：</p> <p><img src="/refactoring-to-patterns-notes/assets/img/7.4.2.f76d289c.jpg" alt=""></p> <p>增加「對 UNIX permission 的支援」會讓 <code>SystemPermission</code> 的狀態改變邏輯變得複雜。考慮以下程式碼：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SystemPermission</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">claimedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>REQUESTED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>UNIX_REQUESTED<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
            
        <span class="token function">willBeHandledBy</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>REQUESTED<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            state <span class="token operator">=</span> CLAIMED<span class="token punctuation">;</span> 
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>UNIX_REQUESTED<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            state <span class="token operator">=</span> UNIX_CLAIMED<span class="token punctuation">;</span> 
        
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deniedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>CLAIMED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>UNIX_CLAIMED<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
            
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>admin<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
            
        isGranted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 
        isUnixPermissionGranted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 
        state <span class="token operator">=</span> DENIED<span class="token punctuation">;</span> 
        <span class="token function">notifyUserOfPermissionRequestResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">grantedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>CLAIMED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>UNIX_CLAIMED<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
            
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>admin<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>profile<span class="token punctuation">.</span><span class="token function">isUnixPermissionRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>UNIX_CLAIMED<span class="token punctuation">)</span><span class="token punctuation">)</span>
            isUnixPermissionGranted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>profile<span class="token punctuation">.</span><span class="token function">isUnixPermissionRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isUnixPermissionGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            state <span class="token operator">=</span> UNIX_REQUESTED<span class="token punctuation">;</span> 
            <span class="token function">notifyUnixAdminsOfPermissionRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
        state <span class="token operator">=</span> GRANTED<span class="token punctuation">;</span> 
        isGranted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
        <span class="token function">notifyUserOfPermissionRequestResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>我們可以嘗試實施 <em>Extract Method</em> 來簡化這些程式碼，例如：</p> <div class="language-java line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">grantedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">isInClaimedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> 
        <span class="token keyword">return</span><span class="token punctuation">;</span> 
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>admin<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span><span class="token punctuation">;</span> 
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span> isUnixPermissionRequestedAn <span class="token function">dClaimed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> 
        isUnixPermissionGranted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">isUnixPermisionDesiredButNotRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        state <span class="token operator">=</span> UNIX_REQUESTED<span class="token punctuation">;</span> 
        <span class="token function">notifyUnixAdminsOfPermissionRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">return</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>雖然這是一個改進，但 <code>SystemPermission</code> 仍有許多狀態特定的布林邏輯，例如 <code>isUnixPermissionRequestedAndClaimed()</code>，而且 <code>grantedBy</code> 還是不夠簡單。該是考慮 refactor to <strong>State</strong> pattern 的時候了。</p> <ol><li><p><code>SystemPermission</code> 有一個 <code>state</code> 欄位，其型別是 <code>String</code>。第一步是實施 <a href="/refactoring-to-patterns-notes/ch9/replace-type-code-with-class.html">Replace Type Code with Class</a>，把 <code>state</code> 的型別改成一個類別。這會獲得以下新類別：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PermissionState</span> <span class="token punctuation">{</span> 
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">PermissionState</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">PermissionState</span> REQUESTED <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PermissionState</span><span class="token punctuation">(</span><span class="token string">&quot;REQUESTED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">PermissionState</span> CLAIMED <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PermissionState</span><span class="token punctuation">(</span><span class="token string">&quot;CLAIMED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">PermissionState</span> GRANTED <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PermissionState</span><span class="token punctuation">(</span><span class="token string">&quot;GRANTED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">PermissionState</span> DENIED <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PermissionState</span><span class="token punctuation">(</span><span class="token string">&quot;DENIED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">PermissionState</span> UNIX_REQUESTED <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PermissionState</span><span class="token punctuation">(</span><span class="token string">&quot;UNIX_REQUESTED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">PermissionState</span> UNIX_CLAIMED <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PermissionState</span><span class="token punctuation">(</span><span class="token string">&quot;UNIX_CLAIMED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> name<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>同時我在 <code>SystemPermission</code> 內以型別為 <code>PermissionState</code> 的 <code>permissionState</code> 欄位取代原本的 <code>state</code> 欄位：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SystemPermission</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">PermissionState</span> permissionState<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">SystemPermission</span><span class="token punctuation">(</span><span class="token class-name">SystemUser</span> requestor<span class="token punctuation">,</span> <span class="token class-name">SystemProfile</span> profile<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token comment">// ... </span>
        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token class-name">PermissionState</span><span class="token punctuation">.</span>REQUESTED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">// ... </span>
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">public</span> <span class="token class-name">PermissionState</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> permissionState <span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token class-name">PermissionState</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        permissionState <span class="token operator">=</span> state<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">claimedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">PermissionState</span><span class="token punctuation">.</span>REQUESTED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">PermissionState</span><span class="token punctuation">.</span>UNIX_REQUESTED<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
        
        <span class="token comment">// ...     </span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div></li> <li><p>現在 <code>PermissionState</code> 有六個常數，都是 <code>PermissionState</code> 實體。為了讓這些常數都成為 <code>PermissionState</code> 的某個子類別實體，我實施六次 <em>Extract Subclass</em> 產生下圖：</p> <p><img src="/refactoring-to-patterns-notes/assets/img/7.4.3.ab10835e.jpg" alt=""></p> <p>因為不再有客戶需要具現 <code>PermissionState</code>，所以我把它宣告為 abstract：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PermissionState</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>接下來尋找 <code>SystemPermission</code> 中的某個函式，該函式會依據狀態轉移邏輯改變 <code>permissionState</code> 的值。有三個這樣的函式：<code>claimedBy()</code>、<code>deniedBy()</code>、<code>grantedBy()</code>。先從 <code>claimedBy()</code> 開始，我必須把這個函式複製給 <code>PermissionState</code> 類別並進行足夠的改變讓它編譯成功，然後以「呼叫新完成的 <code>PermissionState</code> 版本」取代原本的 <code>claimedBy()</code> 函式本體：</p> <div class="language-java line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SystemPermission</span> <span class="token punctuation">{</span>
    <span class="token comment">// private </span>
    <span class="token keyword">void</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token class-name">PermissionState</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// now has package-level visibility </span>
        permissionState <span class="token operator">=</span> state<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">claimedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        permissionState<span class="token punctuation">.</span><span class="token function">claimedBy</span><span class="token punctuation">(</span>admin<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">void</span> <span class="token function">willBeHandledBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>admin <span class="token operator">=</span> admin<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PermissionState</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">claimedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">,</span> <span class="token class-name">SystemPermission</span> permission<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>permission<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>REQUESTED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>permission<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>UNIX_REQUESTED<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
            
        permission<span class="token punctuation">.</span><span class="token function">willBeHandledBy</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">;</span> 

        <span class="token keyword">if</span> <span class="token punctuation">(</span>permission<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>REQUESTED<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            permission<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>CLAIMED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>permission<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>UNIX_REQUESTED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            permission<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>UNIX_CLAIMED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>編譯並測試，檢查這些改變的運作情況。然後對 <code>deniedBy()</code> 和 <code>grantedBy()</code> 重複進行這個步驟。</p></li> <li><p>現在，選一個「<code>SystemPermission</code> 可進入狀態」，找出哪些 <code>PermissionState</code> 函式把這個狀態轉換為其他狀態。我從 <code>REQUESTED</code> 狀態開始，他只能轉換到 <code>CLAIMED</code> 狀態，發生於 <code>PermissionState.claimedBy()</code> 內。我把這個函式複製到 <code>PermissionRequested</code> 類別：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">PermissionRequested</span> <span class="token keyword">extends</span> <span class="token class-name">PermissionState</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">claimedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">,</span> <span class="token class-name">SystemPermission</span> permission<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>permission<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>REQUESTED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>permission<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>UNIX_REQUESTED<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
        
        permission<span class="token punctuation">.</span><span class="token function">willBeHandledBy</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">;</span> 

        <span class="token keyword">if</span> <span class="token punctuation">(</span>permission<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>REQUESTED<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            permission<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>CLAIMED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>permission<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>UNIX_REQUESTED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            permission<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>UNIX_CLAIMED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>這個函式內的許多邏輯都不再需要，例如任何與 <code>UNIX_REQUESTED</code> 狀態有關的東西，因為在 <code>PermissionRequested</code> 我們只關心 <code>REQUESTED</code> 狀態。也不再需要檢查目前狀態是否為 <code>REQUESTED</code>。因此可以把程式碼簡寫成這樣：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">PermissionRequested</span> <span class="token keyword">extends</span> <span class="token class-name">PermissionState</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">claimedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">,</span> <span class="token class-name">SystemPermission</span> permission<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        permission<span class="token punctuation">.</span><span class="token function">willBeHandledBy</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        permission<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>CLAIMED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>CLAIMED</code> 狀態可以轉換為 <code>DENIED</code>、<code>GRANTED</code>、或是 <code>UNIX_REQUESTED</code>。負責處理這些轉換的是 <code>deniedBy()</code> 和 <code>grantedBy()</code>，因此我把這些函式複製到 <code>PermissionClaimed</code> 類別，並刪除不再需要的邏輯：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">PermissionClaimed</span> <span class="token keyword">extends</span> <span class="token class-name">PermissionState</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deniedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">,</span> <span class="token class-name">SystemPermission</span> permission<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token comment">// if (!permission.getState().equals(CLAIMED) &amp;&amp; !permission.getState().equals(UNIX_CLAIMED)) </span>
        <span class="token comment">//     return; </span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>permission<span class="token punctuation">.</span><span class="token function">getAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
        
        permission<span class="token punctuation">.</span><span class="token function">setIsGranted</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        permission<span class="token punctuation">.</span><span class="token function">setIsUnixPermissionGranted</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        permission<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>DENIED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        permission<span class="token punctuation">.</span><span class="token function">notifyUserOfPermissionRequestResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">grantedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">,</span> <span class="token class-name">SystemPermission</span> permission<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token comment">// if (!permission.getState().equals(CLAIMED) &amp;&amp; !permission.getState().equals(UNIX_CLAIMED))</span>
        <span class="token comment">//     return; </span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>permission<span class="token punctuation">.</span><span class="token function">getAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
        
        <span class="token comment">// if (permission.getProfile().isUnixPermissionRequired() &amp;&amp; permission.getState().equals(UNIX_CLAIMED)) </span>
        <span class="token comment">//     permission.setIsUnixPermissionGranted(true); </span>
        <span class="token comment">// else </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>permission<span class="token punctuation">.</span><span class="token function">getProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isUnixPermissionRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>permission<span class="token punctuation">.</span><span class="token function">isUnixPermissionGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            permission<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>UNIX_REQUESTED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            permission<span class="token punctuation">.</span><span class="token function">notifyUnixAdminsOfPermissionRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
        permission<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>GRANTED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        permission<span class="token punctuation">.</span><span class="token function">setIsGranted</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        permission<span class="token punctuation">.</span><span class="token function">notifyUserOfPermissionRequestResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>至於 <code>PermissionGranted</code>，我的工作很輕鬆，一旦 <code>SystemPermission</code> 變成 <code>GRANTED</code> 狀態就再也不能進入到其他狀態。因此這個類別不需要實作任何像 <code>claimedBy()</code> 那樣的轉換函式。他只需要繼承轉換函式的空實作。</p></li> <li><p>回到 <code>PermissionState</code>，現在可以刪除 <code>claimedBy()</code>、<code>deniedBy()</code>、和 <code>grantedBy()</code> 函式本體，程式碼剩這樣：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PermissionState</span> <span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">claimedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">,</span> <span class="token class-name">SystemPermission</span> permission<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deniedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">,</span> <span class="token class-name">SystemPermission</span> permission<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">grantedBy</span><span class="token punctuation">(</span><span class="token class-name">SystemAdmin</span> admin<span class="token punctuation">,</span> <span class="token class-name">SystemPermission</span> permission<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/refactoring-to-patterns-notes/ch7/replace-conditional-dispatcher-with-command.html" class="prev">
        Replace Conditional Dispatcher with Command
      </a></span> <span class="next"><a href="/refactoring-to-patterns-notes/ch7/move-embellishment-to-decorator.html">
        Move Embellishment to Decorator
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/refactoring-to-patterns-notes/assets/js/app.a208a22b.js" defer></script><script src="/refactoring-to-patterns-notes/assets/js/2.51c787ed.js" defer></script><script src="/refactoring-to-patterns-notes/assets/js/7.3b43ce78.js" defer></script>
  </body>
</html>
